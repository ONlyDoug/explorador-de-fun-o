<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Explorador de FunÃ§Ã£o de Primeiro Grau com IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    input[type=range]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #3b82f6;
      cursor: pointer;
      border-radius: 50%;
      border: 2px solid white;
    }

    #gemini-modal {
      transition: opacity 0.3s ease;
    }

    .modal-content {
      transition: transform 0.3s ease;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-6 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">

    <!-- Coluna de Controles e ExplicaÃ§Ãµes -->
    <div class="flex flex-col space-y-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-blue-600">Explorador de FunÃ§Ãµes ðŸ“ˆ</h1>
        <p class="text-gray-600 mt-2">Aprenda sobre a funÃ§Ã£o de primeiro grau <strong class="font-mono">f(x) = ax + b</strong> de forma interativa!</p>
      </div>

      <!-- Controles -->
      <div class="space-y-4 bg-gray-50 p-4 rounded-lg border">
        <div>
          <label for="a-slider" class="font-semibold">Coeficiente Angular (<span class="font-mono text-red-500">a</span>): <span id="a-value" class="font-bold text-blue-600">1</span></label>
          <input id="a-slider" type="range" min="-10" max="10" value="1" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
        <div>
          <label for="b-slider" class="font-semibold">Coeficiente Linear (<span class="font-mono text-green-500">b</span>): <span id="b-value" class="font-bold text-blue-600">2</span></label>
          <input id="b-slider" type="range" min="-10" max="10" value="2" step="0.1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
        </div>
      </div>

      <!-- ExplicaÃ§Ã£o DinÃ¢mica -->
      <div id="explanation-box" class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg">
        <h3 class="font-bold">O que estÃ¡ acontecendo?</h3>
        <p id="explanation-text" class="mt-1 text-sm"></p>
      </div>

      <!-- Calculadora -->
      <div class="bg-gray-50 p-4 rounded-lg border">
        <h3 class="font-semibold mb-2">Calcular f(x) para um ponto</h3>
        <div class="flex items-center space-x-2">
          <span class="font-mono">f(</span>
          <input type="number" id="x-input" value="3" class="w-20 p-2 border border-gray-300 rounded-md text-center">
          <span class="font-mono">) = ?</span>
          <button id="calculate-btn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">Calcular</button>
        </div>
        <p id="result-text" class="mt-3 text-center font-bold text-lg text-blue-700 h-6"></p>
      </div>

      <!-- Recursos com IA -->
      <div class="bg-violet-50 p-4 rounded-lg border border-violet-200">
        <h3 class="font-semibold mb-3 text-violet-800">âœ¨ Recursos com IA (Gemini)</h3>
        <div class="flex flex-col sm:flex-row gap-2">
          <button id="gemini-example-btn" class="flex-1 bg-violet-500 hover:bg-violet-600 text-white font-bold py-2 px-4 rounded-md">Me dÃª um exemplo real</button>
          <button id="gemini-problem-btn" class="flex-1 bg-violet-500 hover:bg-violet-600 text-white font-bold py-2 px-4 rounded-md">Crie um problema</button>
        </div>
      </div>
    </div>

    <!-- GrÃ¡fico -->
    <div class="bg-gray-50 p-4 rounded-lg border flex items-center justify-center">
      <canvas id="functionChart"></canvas>
    </div>
  </div>

  <!-- Modal IA -->
  <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
    <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 transform scale-95">
      <div class="flex justify-between items-center mb-4">
        <h2 id="gemini-modal-title" class="text-xl font-bold text-violet-700">Resposta da IA</h2>
        <button id="gemini-modal-close" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
      </div>
      <div id="gemini-modal-body" class="text-gray-700 space-y-4">
        <div id="gemini-loading" class="flex items-center justify-center py-8">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-violet-500"></div>
        </div>
        <div id="gemini-response-content"></div>
      </div>
    </div>
  </div>

  <script>
    const aSlider = document.getElementById('a-slider');
    const bSlider = document.getElementById('b-slider');
    const aValueSpan = document.getElementById('a-value');
    const bValueSpan = document.getElementById('b-value');
    const explanationText = document.getElementById('explanation-text');
    const xInput = document.getElementById('x-input');
    const calculateBtn = document.getElementById('calculate-btn');
    const resultText = document.getElementById('result-text');
    const ctx = document.getElementById('functionChart').getContext('2d');
    const geminiExampleBtn = document.getElementById('gemini-example-btn');
    const geminiProblemBtn = document.getElementById('gemini-problem-btn');
    const geminiModal = document.getElementById('gemini-modal');
    const geminiModalTitle = document.getElementById('gemini-modal-title');
    const geminiModalClose = document.getElementById('gemini-modal-close');
    const geminiLoading = document.getElementById('gemini-loading');
    const geminiResponseContent = document.getElementById('gemini-response-content');
    let chart;

    function generateFunctionData(a, b) {
      const data = []; const labels = [];
      for (let x = -10; x <= 10; x++) { labels.push(x); data.push(a * x + b); }
      return { labels, data };
    }

    function initializeChart() {
      const { labels, data } = generateFunctionData(parseFloat(aSlider.value), parseFloat(bSlider.value));
      chart = new Chart(ctx, {
        type: 'line', data: { labels, datasets: [{ data, borderColor: '#3b82f6', borderWidth: 3, tension: 0.1, pointRadius: 0 }] },
        options: { responsive: true, maintainAspectRatio: true, animation: { duration: 0 }, scales: { y: { title: { display: true, text: 'Eixo Y' } }, x: { title: { display: true, text: 'Eixo X' } } }, plugins: { legend: { display: false } } }
      });
    }

    function updateApp() {
      const a = parseFloat(aSlider.value); const b = parseFloat(bSlider.value);
      aValueSpan.textContent = a.toFixed(1); bValueSpan.textContent = b.toFixed(1);
      const { labels, data } = generateFunctionData(a, b);
      chart.data.labels = labels; chart.data.datasets[0].data = data;
      chart.update(); updateExplanation(a, b); resultText.textContent = '';
    }

    function updateExplanation(a, b) {
      let explanation = '';
      if (a > 0) explanation = `Como <strong>a (${a.toFixed(1)})</strong> Ã© positivo, a reta Ã© <strong>crescente</strong>. `;
      else if (a < 0) explanation = `Como <strong>a (${a.toFixed(1)})</strong> Ã© negativo, a reta Ã© <strong>decrescente</strong>. `;
      else explanation = `Como <strong>a</strong> Ã© zero, a reta Ã© <strong>constante</strong>. `;
      explanation += `O coeficiente <strong>b (${b.toFixed(1)})</strong> nos diz onde a reta <strong>corta o eixo Y</strong>.`;
      explanationText.innerHTML = explanation;
    }

    function calculateFx() {
      const y = parseFloat(aSlider.value) * parseFloat(xInput.value) + parseFloat(bSlider.value);
      resultText.textContent = `f(${xInput.value}) = ${y.toFixed(2)}`;
    }

    function toggleModal(show) {
      if (show) {
        geminiModal.classList.remove('hidden');
        setTimeout(() => { geminiModal.classList.remove('opacity-0'); geminiModal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
      } else {
        geminiModal.classList.add('opacity-0');
        geminiModal.querySelector('.modal-content').classList.add('scale-95');
        setTimeout(() => geminiModal.classList.add('hidden'), 300);
      }
    }

    async function callBackendAPI(prompt) {
      geminiResponseContent.innerHTML = '';
      geminiLoading.classList.remove('hidden');
      toggleModal(true);

      try {
        const response = await fetch('/api/gemini', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt })
        });

        if (!response.ok) { throw new Error(`Erro no servidor: ${response.status}`); }

        const result = await response.json();
        geminiResponseContent.innerHTML = result.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

      } catch (error) {
        console.error("Erro ao chamar o backend:", error);
        geminiResponseContent.textContent = `Ocorreu um erro: ${error.message}. Verifique o console.`;
      } finally {
        geminiLoading.classList.add('hidden');
      }
    }

    geminiExampleBtn.addEventListener('click', () => {
      const a = parseFloat(aSlider.value).toFixed(1); const b = parseFloat(bSlider.value).toFixed(1);
      const prompt = `VocÃª Ã© um tutor de matemÃ¡tica amigÃ¡vel. Crie um exemplo simples e prÃ¡tico do mundo real para a funÃ§Ã£o f(x) = ${a}x + ${b}. Explique como 'a' e 'b' se encaixam no exemplo. Mantenha a explicaÃ§Ã£o curta. Use negrito para destacar os valores.`;
      geminiModalTitle.textContent = "Exemplo do Mundo Real";
      callBackendAPI(prompt);
    });

    geminiProblemBtn.addEventListener('click', () => {
      const a = parseFloat(aSlider.value).toFixed(1); const b = parseFloat(bSlider.value).toFixed(1);
      const randomX = Math.floor(Math.random() * 13) + 2;
      const prompt = `VocÃª Ã© um professor de matemÃ¡tica. Baseado na funÃ§Ã£o f(x) = ${a}x + ${b}, crie um problema de palavra curto que peÃ§a para calcular f(${randomX}). Depois, em uma nova linha, escreva '---' e forneÃ§a a **Resposta** e a resoluÃ§Ã£o.`;
      geminiModalTitle.textContent = "Desafio MatemÃ¡tico";
      callBackendAPI(prompt);
    });

    geminiModalClose.addEventListener('click', () => toggleModal(false));
    geminiModal.addEventListener('click', (e) => { if (e.target === geminiModal) toggleModal(false); });
    aSlider.addEventListener('input', updateApp);
    bSlider.addEventListener('input', updateApp);
    calculateBtn.addEventListener('click', calculateFx);
    xInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') calculateFx(); });

    window.onload = () => { initializeChart(); updateApp(); };
  </script>
</body>

</html>